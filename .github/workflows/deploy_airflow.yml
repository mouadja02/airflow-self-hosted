name: ðŸ“¦ Airflow Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      steps:
        description: 'Select which steps to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'test'
          - 'deploy'
          - 'all'
  push:
    branches:
      - main
    paths:
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'dags/**'
      - 'requirements.txt'

jobs:
  test:
    name: ðŸ§ª Build & Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.steps == 'test' || github.event.inputs.steps == 'all'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          touch .env
          echo "AIRFLOW_UID=50000" >> .env
          echo "_AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}" >> .env
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}" >> .env
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> .env
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> .env
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}" >> .env
          echo "SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}" >> .env
          echo "SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}" >> .env
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> .env

      - name: Build and Start Containers
        run: |
          echo "ðŸ”¨ Building Docker containers..."
          docker compose up -d --build --quiet-pull 2>&1 | grep -v "Pulling\|Download\|Extracting\|Waiting" || true
          echo "âœ… Containers started"

      - name: Wait for Healthchecks
        id: healthcheck
        run: |
          echo "â³ Waiting for services to initialize..."
          sleep 60 
          
          for i in {1..6}; do
            UNHEALTHY=$(docker compose ps --services | xargs -I {} docker inspect --format '{{.State.Health.Status}}' $(docker compose ps -q {}) 2>/dev/null | grep -v "healthy" || true)
            
            if [ -z "$UNHEALTHY" ]; then
              echo "âœ… All services are healthy!"
              exit 0
            fi
            echo "â³ Services not healthy yet... waiting 10s (attempt $i/6)"
            sleep 10
          done
          
          echo "âŒ Timed out waiting for services to be healthy."
          docker compose ps
          docker compose logs --tail=50
          exit 1

      - name: Stop Containers
        if: always()
        run: docker compose down -v --remove-orphans

  deploy:
    name: ðŸš€ Deploy to Raspberry Pi
    runs-on: ubuntu-latest
    needs: test
    if: (github.event_name == 'push' && success()) || github.event.inputs.steps == 'deploy' || github.event.inputs.steps == 'all'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared & SSH Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sshpass > /dev/null 2>&1
          curl -sL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq cloudflared > /dev/null 2>&1
          echo "âœ… Tools installed"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/config <<EOF
          Host ssh.mj-dev.net
            User ${{ secrets.RASPBERRY_PI_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Prepare Deployment Files
        run: |
          # Create the .env file
          echo "AIRFLOW_UID=50000" > .env
          echo "_AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}" >> .env
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}" >> .env
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> .env
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> .env
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}" >> .env
          echo "SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}" >> .env
          echo "SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}" >> .env
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> .env

          # Create deployment script
          cat <<'EOF' > deploy_script.sh
          #!/bin/bash
          set -e
          
          echo "ðŸ“‚ Navigating to project..."
          cd ${{ secrets.AIRFLOW_PATH }}

          echo "â¬‡ï¸ Pulling latest changes..."
          git remote set-url origin https://${{ secrets.TOKEN }}@github.com/mouadja02/airflow-self-hosted.git
          git pull origin main

          echo "ðŸ” Moving new .env file into place..."
          mv /tmp/.env .

          echo "ðŸ³ Docker Compose Up..."
          docker compose down --remove-orphans 2>&1 | grep -v "Container\|Network\|Volume" || true
          
          # Suppress build output, only show errors
          docker compose up -d --build 2>&1 | \
            grep -vE "Pulling|Download|Extracting|Waiting|Pull complete|Already exists|sha256" | \
            grep -E "ERROR|WARNING|Building|Built|Created|Started|^$" || true

          echo "ðŸ§¹ Cleaning up..."
          docker image prune -f > /dev/null 2>&1
          rm -f /tmp/deploy_script.sh
          
          echo "âœ… Deployment Successfully Completed!"
          EOF

      - name: Transfer and Execute
        env:
          SSH_PASS: ${{ secrets.RASPBERRY_PI_PASSWORD }}
        run: |
          echo "ðŸ“¤ Uploading files to Raspberry Pi..."
          sshpass -p "$SSH_PASS" scp .env deploy_script.sh ssh.mj-dev.net:/tmp/

          echo "ðŸš€ Executing deployment..."
          sshpass -p "$SSH_PASS" ssh ssh.mj-dev.net "bash /tmp/deploy_script.sh"
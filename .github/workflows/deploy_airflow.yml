name: ðŸ“¦ Airflow Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force full rebuild?'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main

jobs:
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      needs-rebuild: ${{ steps.filter.outputs.needs-rebuild }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed files
        id: filter
        run: |
          # Infrastructure files that require rebuild
          INFRA_FILES="docker-compose.yml Dockerfile airflow.cfg requirements.txt"
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          
          # Check if any infrastructure file changed
          NEEDS_REBUILD=false
          for file in $INFRA_FILES; do
            if echo "$CHANGED_FILES" | grep -q "^$file$"; then
              NEEDS_REBUILD=true
              echo "ðŸ”¨ Infrastructure file changed: $file"
              break
            fi
          done
          
          if [ "$NEEDS_REBUILD" = true ] || [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "needs-rebuild=true" >> $GITHUB_OUTPUT
            echo "âœ… Full rebuild required"
          else
            echo "needs-rebuild=false" >> $GITHUB_OUTPUT
            echo "âœ… Only code changes - sync only"
          fi

  test:
    name: ðŸ§ª Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.needs-rebuild == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          touch .env
          echo "AIRFLOW_UID=50000" >> .env
          echo "_AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}" >> .env
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}" >> .env
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> .env
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> .env
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}" >> .env
          echo "SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}" >> .env
          echo "SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}" >> .env
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> .env

      - name: Build and Start Containers
        run: |
          echo "ðŸ”¨ Building Docker containers..."
          docker compose up -d --build --quiet-pull 2>&1 | grep -v "Pulling\|Download\|Extracting\|Waiting" || true
          echo "âœ… Containers started"

      - name: Wait for Healthchecks
        id: healthcheck
        run: |
          echo "â³ Waiting for services to initialize..."
          sleep 60 
          
          for i in {1..6}; do
            UNHEALTHY=$(docker compose ps --services | xargs -I {} docker inspect --format '{{.State.Health.Status}}' $(docker compose ps -q {}) 2>/dev/null | grep -v "healthy" || true)
            
            if [ -z "$UNHEALTHY" ]; then
              echo "âœ… All services are healthy!"
              exit 0
            fi
            echo "â³ Services not healthy yet... waiting 10s (attempt $i/6)"
            sleep 10
          done
          
          echo "âŒ Timed out waiting for services to be healthy."
          docker compose ps
          docker compose logs --tail=50
          exit 1

      - name: Stop Containers
        if: always()
        run: docker compose down -v --remove-orphans

  deploy-dags-only:
    name: ðŸš€ Sync Changes Only
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.needs-rebuild == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared & SSH Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sshpass > /dev/null 2>&1
          curl -sL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq cloudflared > /dev/null 2>&1
          echo "âœ… Tools installed"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/config <<EOF
          Host ssh.mj-dev.net
            User ${{ secrets.RASPBERRY_PI_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Quick DAG Sync
        env:
          SSH_PASS: ${{ secrets.RASPBERRY_PI_PASSWORD }}
        run: |
          echo "ðŸ“‚ Syncing changes only (no container rebuild)..."
          
          cat <<'EOF' > sync_changes.sh
          #!/bin/bash
          set -e
          
          echo "ðŸ“‚ Navigating to project..."
          cd ${{ secrets.AIRFLOW_PATH }}

          echo "ðŸ”“ Fixing permissions before pull..."
          echo "${{ secrets.RASPBERRY_PI_PASSWORD }}" | sudo -S chown -R $(whoami):$(whoami) .

          echo "â¬‡ï¸ Pulling latest changes..."
          git remote set-url origin https://${{ secrets.TOKEN }}@github.com/mouadja02/airflow-self-hosted.git
          git pull origin main

          echo "ðŸ”’ Restoring Airflow permissions..."
          echo "${{ secrets.RASPBERRY_PI_PASSWORD }}" | sudo -S chown -R 50000:50000 dags/ logs/ plugins/ config/

          echo "âœ… Changes synced! Airflow will pick them up automatically."
          rm -f /tmp/sync_changes.sh
          EOF

          echo "ðŸ“¤ Uploading sync script..."
          sshpass -p "$SSH_PASS" scp sync_changes.sh ssh.mj-dev.net:/tmp/

          echo "ðŸš€ Executing sync..."
          sshpass -p "$SSH_PASS" ssh ssh.mj-dev.net "bash /tmp/sync_changes.sh"

  deploy-full:
    name: ðŸš€ Full Rebuild & Deploy
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.needs-rebuild == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared & SSH Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sshpass > /dev/null 2>&1
          curl -sL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list > /dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq cloudflared > /dev/null 2>&1
          echo "âœ… Tools installed"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/config <<EOF
          Host ssh.mj-dev.net
            User ${{ secrets.RASPBERRY_PI_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Prepare Deployment Files
        run: |
          # Create the .env file
          echo "AIRFLOW_UID=50000" > .env
          echo "_AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}" >> .env
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}" >> .env
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> .env
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> .env
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}" >> .env
          echo "SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}" >> .env
          echo "SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}" >> .env
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> .env

          # Create deployment script
          cat <<'EOF' > deploy_script.sh
          #!/bin/bash
          set -e
          
          echo "ðŸ“‚ Navigating to project..."
          cd ${{ secrets.AIRFLOW_PATH }}

          echo "â¬‡ï¸ Pulling latest changes..."
          git remote set-url origin https://${{ secrets.TOKEN }}@github.com/mouadja02/airflow-self-hosted.git
          git pull origin main

          echo "ðŸ” Moving new .env file into place..."
          mv /tmp/.env .

          echo "ðŸ³ Rebuilding and restarting containers..."
          docker compose up -d --build --force-recreate --remove-orphans 2>&1 | \
            grep -vE "Pulling|Download|Extracting|Waiting|Pull complete|Already exists|sha256" | \
            grep -E "ERROR|WARNING|Building|Built|Created|Started|^$" || true

          echo "ðŸ§¹ Cleaning up..."
          docker image prune -f > /dev/null 2>&1
          rm -f /tmp/deploy_script.sh
          
          echo "âœ… Full Deployment Successfully Completed!"
          EOF

      - name: Transfer and Execute
        env:
          SSH_PASS: ${{ secrets.RASPBERRY_PI_PASSWORD }}
        run: |
          echo "ðŸ“¤ Uploading files to Raspberry Pi..."
          sshpass -p "$SSH_PASS" scp .env deploy_script.sh ssh.mj-dev.net:/tmp/

          echo "ðŸš€ Executing full deployment..."
          sshpass -p "$SSH_PASS" ssh ssh.mj-dev.net "bash /tmp/deploy_script.sh"
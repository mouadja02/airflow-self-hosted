name: üì¶ Airflow Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      steps:
        description: 'Select which steps to run'
        required: false
        default: 'test,deploy'
        type: choice
        options:
          - 'test'
          - 'deploy'
          - 'all'
  push:
    branches:
      - main
    paths:
      - 'docker-compose.yml'
      - 'Dockerfile'
      - 'dags/**'
      - 'requirements.txt'

jobs:
  test:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    if: github.event.inputs.steps == 'test' || github.event.inputs.steps == 'all' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          touch .env
          echo "AIRFLOW_UID=${{ secrets.AIRFLOW_UID }}" >> .env
          echo "_AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}" >> .env
          echo "_AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}" >> .env
          echo "SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}" >> .env
          echo "SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}" >> .env
          echo "SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}" >> .env
          echo "SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}" >> .env
          echo "SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}" >> .env
          echo "SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}" >> .env
          echo "SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}" >> .env

      - name: Build and Start Containers
        run: docker compose up -d --build

      - name: Wait for Healthchecks
        id: healthcheck
        run: |
          echo "Waiting for services to initialize..."
          sleep 60 
          
          # Loop to check health status for 60 more seconds
          for i in {1..6}; do
            UNHEALTHY=$(docker compose ps --services | xargs -I {} docker inspect --format '{{.State.Health.Status}}' $(docker compose ps -q {}) | grep -v "healthy" || true)
            
            if [ -z "$UNHEALTHY" ]; then
              echo "‚úÖ All services are healthy!"
              exit 0
            fi
            echo "‚è≥ Services not healthy yet... waiting 10s"
            sleep 10
          done
          
          echo "‚ùå Timed out waiting for services to be healthy."
          docker compose ps
          docker compose logs
          exit 1

      - name: Stop Containers
        if: always()
        run: docker compose down -v

  deploy:
    name: üöÄ Deploy to Raspberry Pi
    runs-on: ubuntu-latest
    if: github.event.inputs.steps == 'deploy' || github.event.inputs.steps == 'all' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Cloudflared & SSH Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          
          # Install Cloudflared
          curl -L https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-archive-keyring.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-archive-keyring.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt-get update
          sudo apt-get install cloudflared

      - name: Configure SSH
        # THIS IS THE FIX: We write the config to a file to avoid quoting errors
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/config <<EOF
          Host ssh.mj-dev.net
            User ${{ secrets.RASPBERRY_PI_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Deploy Script
        env:
          SSH_PASS: ${{ secrets.RASPBERRY_PI_PASSWORD }}
          AIRFLOW_PATH: ${{ secrets.AIRFLOW_PATH }}
          GIT_TOKEN: ${{ secrets.TOKEN }}
        run: |
          # Now the command is clean because the ProxyCommand is hidden in the config file
          sshpass -p "$SSH_PASS" ssh ssh.mj-dev.net bash -c "'
            set -e

            echo \"üìÇ Navigating to project directory: $AIRFLOW_PATH\"
            cd $AIRFLOW_PATH

            echo \"‚¨áÔ∏è  Pulling latest code...\"
            # Ensure git uses the token for this pull
            git remote set-url origin https://$GIT_TOKEN@github.com/mouadja02/airflow-self-hosted.git
            git pull origin main

            echo \"‚öôÔ∏è  Updating .env file...\"
            # We rewrite the .env file to ensure latest secrets
            cat <<ENV_EOF > .env
            AIRFLOW_UID=${{ secrets.AIRFLOW_UID }}
            _AIRFLOW_WWW_USER_USERNAME=${{ secrets._AIRFLOW_WWW_USER_USERNAME }}
            _AIRFLOW_WWW_USER_PASSWORD=${{ secrets._AIRFLOW_WWW_USER_PASSWORD }}
            SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}
            SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}
            SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}
            SNOWFLAKE_WAREHOUSE=${{ secrets.SNOWFLAKE_WAREHOUSE }}
            SNOWFLAKE_DATABASE=${{ secrets.SNOWFLAKE_DATABASE }}
            SNOWFLAKE_SCHEMA=${{ secrets.SNOWFLAKE_SCHEMA }}
            SNOWFLAKE_ROLE=${{ secrets.SNOWFLAKE_ROLE }}
            ENV_EOF

            echo \"üê≥ Rebuilding and Restarting Containers...\"
            # Force recreate to ensure new env vars are picked up
            docker compose up -d --build --remove-orphans

            echo \"‚úÖ Deployment Successfully Completed!\"
          '"
